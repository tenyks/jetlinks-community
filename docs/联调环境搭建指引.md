

# UDP Tunnel打通

## 远程机器
监听udp:5683端口，并把数据发给`TCP:5906`
```shell
socat -d -d -d -d -T 360 udp-listen:5906 TCP4:127.0.0.1:5906
```
启动脚本
```shell
ssh -R 5906:localhost:5683 lzy@110.41.151.208 /home/lzy/bin/start-5906s.sh
```

## 本地机器
监听TCP:5683端口，并把数据转发给`目标机器:5683`
```shell
socat -d -d -d -d -T 360 tcp-listen:5683 UDP4:192.168.137.1:5683
```
启动脚本
```shell
~/bin/start-5683s.sh
```

# NB卡BC35联调
* 测试AT指令功能是否正常
```AT
AT

OK
```
* 获取信号强度指示
```AT
AT+CSQ
+CSQ:26,99

OK
```
* 查询网络注册状态 
查询当前 EPS 网络注册状态，该指令返回的第一个参数为0则表示禁止网络注册URC，第二个参数表示网络注册状态，1表示已注册本地网，5表示已注册***网络，其余值则表示注册失败。
```AT
AT+CEREG?
+CEREG:0,1

OK
```
* 查询网络是否被激活
  该命令用于查询当前是否将 UE 附着于 PS 域，返回值为1则表示已附着，即网络激活成功。
```AT
AT+CGATT?
+CGATT:1

OK
```
* 查询模块的 IP 地址
```AT
AT+CGPADDR
+CGPADDR:0,100.1.32.232
OK
```

* 查询产品信息
```AT
ATI
Quectel
BC35-G
Revision:BC35GJCXR03A01_ONT

OK
```

* 查询模块版本信息
```AT
AT+CGMI

OK

AT+CGMR
SSB,V150R100C10B200SP1
SECURITY_A,V150R100C20B600
PROTOCOL_A,V150R100C20B600
APPLICATION_A,V150R100C20B600
SECURITY_B,V150R100C20B600
RADIO,Hi2115_RF23

OK

AT+CGSN=?
+CGSN:(0,1,2,3)

OK

AT+CGSN=1
+CGSN:868411057164360

OK

AT+CIMI
460043152012815

OK

```
* 查询网络注册状态（协议层次上），休眠时间等等
```AT
AT+CEREG=?
+CEREG:(0,1,2,3,4,5)

OK

AT+CEREG
+CEREG:1,1 -- 表示注册成功

OK
```
* 查询无线电连接状态(即到基站)的详细信息。（物理信号层次）
```AT
AT+CSCON?
+CSCON:0,0

OK
```
< n > Integer type. Enable/disable unsolicited result code.
0 — Disable unsolicited result code
1 — Enable unsolicited result code: “+CSCON:< mode >”
< mode > Integer type. The signalling connection status.
0 — Idle
1 — Connected

* 查询运营商
```AT
AT+CGPADDR
+CGPADDR:0,100.1.32.232
OK
```

* 模块连接到基站
```AT
AT+CGATT=?
+CGATT:(0,1) -- 0=断开连接，1=附着（连接）

OK
```

* 设置模块在上电时射频工作模式
  自动/手动联网相关,默认是1,即自动的
```AT
AT+CFUN?
+CFUN:1

OK
```

* 打印设备指令使用出错信息
```AT
AT+CMEE=?
+CMEE:(0,1) -- 1=打印错误报告信息， 0=关闭打印错误报告信息

OK

AT+CMEE=1 
OK

AT+CEER=1 -- 输出更多的错误信息
```

* 请求当前时间
```AT
AT+CCLK?
+CCLK:24/06/08,06:36:19+32

OK

```

## 通用命令
* 重启模块：`AT+NRB`
* 请求模块状态信息：
```AT
AT+NUESTATS
Signal power:-808
Total power:-671
TX power:230
TX time:2179
RX time:22239
Cell ID:223540295
ECL:1
SNR:-33
EARFCN:3686
PCI:204
RSRQ:-150
OPERATOR MODE:4
CURRENT BAND:8

OK
```
* 设置调试日志记录级别：`AT+NLOGLEVEL`
* 配置模块信息：`AT+NCONFIG`
* 块省电模式报告：`AT+NPSMR`

## LwM2M上云
* 设置电信/华为云的CDP
```AT
AT+NCDP?
+NCDP:124.70.30.197,5683

OK
```

* 启动物联网平台的注册、注销或更新
```AT
AT+QLWSREGIND
```

* 用于向华为的LWM2M协议物联网平台发送数据
```AT
AT+QLWULDATA=3,AA34BB
```

* 此命令查询发送CON数据到NB-IoT平台的状态
```AT

```

* 查询
```AT

```

* 查询
```AT

```

* 查询
```AT

```

* 查询
```AT

```

## UPD通信

* 禁用IoT平台的注册功能
  由于NB-IoT模组可以直接对接IoT平台，所以在单独测试使用UDP连接时，需要在激活网络成功之后，在获取ip地址之前，关闭IoT平台注册功能。
```AT
AT+QREGSWT?
+QREGSWT:2

OK
```

使用如下命令禁止该功能：
```AT
AT+QREGSWT=2
```


* 创建Socket
`AT+NSOCR=<type>,<protocol>,<listen port>`
```AT
AT+NSOCR=DGRAM,17,0
```

* 模组向服务器发送消息
`AT+NSOST=<socket>,<remote_addr>,<remote_port>,<length>,<data>`
  
```AT
AT+NSOST=1,122.51.89.94,8000,4,30313233

1,4

OK
```

* 模组接收服务器消息
`AT+NSORF=<socket>,<req_length>`
```AT
AT+NSORF=1,18

1,122.51.89.94,8000,18,48656C6C6F2C75647020636C69656E74210A,0

OK
```

* 关闭socket
`AT+NSOCL=<socket>`
```AT
AT+NSOCL=1

OK
```